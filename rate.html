<script>
  // Ton Apps Script Web App (même URL pour API et logs)
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzDZlUPV63mcL1a5NIq_Sj1ia0MCzUrcQX41I7yG8R85bkOsOHxFnEOoj0atOh43YZV/exec';
  const LOG_ENDPOINT = API_BASE;
  const LOW_STARS_MAX = 3; // 1..3 → Form, 4..5 → Google

  (async function init(){
    const params = new URLSearchParams(location.search);
    const businessId = params.get('id') || '';
    const plaqueId = params.get('plaque') || '';

    if (!businessId) {
      document.getElementById('msg').textContent = 'Paramètre ?id manquant.';
      return;
    }

    // 1) Récupère la config entreprise
    let biz;
    try {
      const res = await fetch(`${API_BASE}?id=${encodeURIComponent(businessId)}`, { cache:'no-store' });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'API error');
      biz = data;
    } catch (e) {
      console.error(e);
      document.getElementById('msg').textContent = 'Erreur de configuration.';
      return;
    }

    document.getElementById('biz-name').textContent = biz.name || 'Votre expérience';

    // 2) UI étoiles
    const starsEl = document.getElementById('stars');
    const buttons = [...starsEl.querySelectorAll('button')];
    const submit = document.getElementById('submit');
    let rating = 0;

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        rating = Number(btn.dataset.value);
        buttons.forEach(b => b.classList.toggle('active', Number(b.dataset.value) <= rating));
        submit.disabled = false;
        submit.classList.add('enabled');
        document.getElementById('msg').textContent = `Note sélectionnée : ${rating} ★`;
      });
    });

    // 3) Envoi + redirection
    submit.addEventListener('click', async () => {
      if (!rating) return;

      // log non bloquant (évite le preflight CORS)
      const payload = {
        ts: new Date().toISOString(),
        business_id: businessId,
        plaque_id: plaqueId || '',
        rating,
        userAgent: navigator.userAgent,
        referer: document.referrer
      };
      try {
        navigator.sendBeacon?.(LOG_ENDPOINT, JSON.stringify(payload)) ||
        await fetch(LOG_ENDPOINT, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
      } catch {}

      // 1–3 → Google Form | 4–5 → Google Reviews
      const goForm = () => {
        const url = biz.lowRatingFormUrl || '#';
        // utilise replace pour éviter tout blocage de navigation
        window.location.replace(url);
      };
      const goGoogle = () => {
        const url = biz.googleReviewUrl || '#';
        window.location.replace(url);
      };

      if (rating <= LOW_STARS_MAX) goForm(); else goGoogle();
    });
  })();
</script>
